name: Build All Platforms (Windows + macOS)

on:
  push:
    branches: [main, master]
    tags:
      - "v*"
  workflow_dispatch:

env:
  QT_VERSION: "6.6.2"
  BUILD_TYPE: Release
  APP_NAME: ClanManager

jobs:
  # ==================== WINDOWS BUILD ====================
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: ${{ env.QT_VERSION }}
          host: windows
          target: desktop
          arch: win64_msvc2019_64
          cache: true

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Configure CMake
        run: cmake -B build -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} -G "Ninja"

      - name: Build
        run: cmake --build build --config ${{ env.BUILD_TYPE }}

      - name: Create Distribution Folder
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "dist\ClanManager"
          Copy-Item "build\ClanManager.exe" -Destination "dist\ClanManager\"

      - name: Deploy Qt Dependencies
        shell: cmd
        run: windeployqt --release --no-translations --no-system-d3d-compiler --no-opengl-sw dist\ClanManager\ClanManager.exe

      - name: Add Demo Data & README
        shell: pwsh
        run: |
          if (Test-Path "distribution\demo_players.csv") { Copy-Item "distribution\demo_players.csv" -Destination "dist\ClanManager\" }
          if (Test-Path "distribution\README_Windows.txt") { Copy-Item "distribution\README_Windows.txt" -Destination "dist\ClanManager\LIESMICH.txt" }

      - name: Download VC++ Redistributable
        shell: pwsh
        run: Invoke-WebRequest -Uri "https://aka.ms/vs/17/release/vc_redist.x64.exe" -OutFile "dist\ClanManager\vc_redist.x64.exe"

      - name: Create Start Script
        shell: pwsh
        run: |
          $script = @'
          @echo off
          echo ========================================
          echo   ClanManager - Erster Start
          echo ========================================
          echo.
          if not exist "%~dp0runtime_ok.txt" (
            echo Visual C++ Runtime wird installiert...
            start /wait "" "%~dp0vc_redist.x64.exe" /install /quiet /norestart
            echo OK > "%~dp0runtime_ok.txt"
          )
          start "" "%~dp0ClanManager.exe"
          '@
          Set-Content -Path "dist\ClanManager\ClanManager_Starten.bat" -Value $script

      - name: Create Windows ZIP
        shell: pwsh
        run: Compress-Archive -Path "dist\ClanManager\*" -DestinationPath "ClanManager-Windows-x64.zip" -Force

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ClanManager-Windows-x64
          path: ClanManager-Windows-x64.zip
          retention-days: 30

  # ==================== macOS BUILD ====================
  build-macos:
    runs-on: macos-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: ${{ env.QT_VERSION }}
          host: mac
          target: desktop
          arch: clang_64
          cache: true

      - name: Configure CMake
        run: cmake -B build -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}

      - name: Build
        run: cmake --build build --config ${{ env.BUILD_TYPE }}

      - name: Deploy Qt Dependencies (macdeployqt)
        run: |
          macdeployqt build/ClanManager.app -always-overwrite

      - name: Sign App Bundle (Ad-hoc)
        run: |
          codesign --force --deep --sign - build/ClanManager.app
          codesign --verify --deep --strict build/ClanManager.app

      - name: Add Demo Data
        run: |
          cp distribution/demo_players.csv build/ClanManager.app/Contents/MacOS/ 2>/dev/null || true

      - name: Create macOS DMG
        run: |
          mkdir -p dist
          hdiutil create -volname "ClanManager" -srcfolder build/ClanManager.app -ov -format UDZO dist/ClanManager-macOS.dmg

      - name: Create macOS ZIP (Alternative)
        run: |
          cd build
          zip -r ../ClanManager-macOS.zip ClanManager.app

      - name: Upload macOS DMG
        uses: actions/upload-artifact@v4
        with:
          name: ClanManager-macOS-DMG
          path: dist/ClanManager-macOS.dmg
          retention-days: 30

      - name: Upload macOS ZIP
        uses: actions/upload-artifact@v4
        with:
          name: ClanManager-macOS-ZIP
          path: ClanManager-macOS.zip
          retention-days: 30

  # ==================== CREATE RELEASE ====================
  create-release:
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure
        run: ls -la artifacts/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/ClanManager-Windows-x64/ClanManager-Windows-x64.zip
            artifacts/ClanManager-macOS-DMG/ClanManager-macOS.dmg
            artifacts/ClanManager-macOS-ZIP/ClanManager-macOS.zip
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
